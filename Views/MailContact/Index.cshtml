@using Kendo.Mvc.UI;
<div class="modal" id="MailContact">
@Automation.Helper.winClass.windowHeader("", " ویرایش ایمیل", 600, 350)
    <script src="@Url.Content("~/Content/Base.js")" type="text/javascript"></script>
    <div>
        <br />
        <center>
            <table>
                    

                <tr>
                    <td align="center" colspan="6">
                        <p>
                            @Automation.Helper.winClass.Buttons("Send", "ارسال", "Next")
                            @Automation.Helper.winClass.Buttons("exitMail", "خروج", "Exit")
                        </p>
                    </td>
                </tr>
                <tr>
                <td>
                <span id="lblEmailAdressError" style="color: Red;"></span>
                </td>
                </tr>
              
            </table>
        </center>
       
     
        
        <div class="k-rtl demo-section">
            @(Html.Kendo().Grid<Automation.Models.EmailContact>()
                .Name("GridMail")
                .Scrollable(scrollable => scrollable.Virtual(true).Height(200))
                .Columns(columns =>
                {
                    columns.Bound(p => p.fldReciverName).Title("گیرنده");
                    columns.Bound(p => p.fldEmailAddress).Title("آدرس ایمیل"); 
                })
            .Editable(editable => editable.Mode(GridEditMode.InCell))
            .Selectable(selectable => selectable.Mode(GridSelectionMode.Single))
            .Scrollable(scrol => scrol.Enabled(true))
            //.Sortable()
            //.Filterable()
            
            .Resizable(resize => resize.Columns(true))
            .DataSource(data =>
                data.Ajax()
                                                        //.Read("Fill", "MailContact")
            .Model(m =>
              {
                  m.Id(p => p.fldReciverName);
                  m.Field(p => p.fldReciverName).Editable(false);
              }
            )
            )
                )
                </div>

        </div>
        <script type="text/javascript">

            var err = false;
            $("document").ready(function () {

                $("#Send").button();
                $("#exitMail").button();

                State = '@ViewBag.State';
                LetterID = '@ViewBag.LetterID';
                ReciverName = '@ViewBag.ReciverName';
                EmailAddress = '@ViewBag.EmailAddress';

                $("#exitMail").click(function () {
                    $("#MailContact").remove();
                    isWinOpen = false;
                });

                $('#MailContact').on('keyup', 'input', function (event) {
                    if (event.which == 13) {
                        var inputs = $('#MailContact').find(':input:visible');
                        inputs.eq(inputs.index(this) + 1).focus();
                    }
                });
                $('#MailContact #btnClose').click(function () {
                    $("#MailContact").remove();
                    isWinOpen = false;
                });

                $(document).keyup(function (e) {
                    if (e.keyCode == 27) {
                        $("#MailContact").remove();
                        isWinOpen = false;
                    }
                });





                var url = '@Url.Action("ReloadGride", "MailContact")';
                ReloadMail(url, 'GridMail', ReciverName, EmailAddress);


                $("#Send").click(function () {
                    err = false;
                    var entityGrid = $("#GridMail").data("kendoGrid");
                    var row = entityGrid.items();

                    ReciverEmailAddress = '';
                    // Email;

                    var h = 0;
                    for (var k = 0; k < row.length; k++) {
                        var selectedItem = entityGrid.dataItem(row[k]);
                        var Email = selectedItem.fldEmailAddress;
                        if (Email != "") {
                            $.ajax({
                                url: '/Email/IsValidEmail',
                                type: 'get',
                                datatype: 'json',
                                data: { strIn: Email },
                                error: function (xhr, status, error) {
                                    alert(xhr + status);
                                },
                                success: function (result) {
                                    h++; //بدلیل نفهمیدن k 
                                    if (result.valid == false) {
                                        err = true;
                                        $('#lblEmailAdressError').html('ایمیل نامعتبر است.');
                                    }
                                    else {
                                        ReciverEmailAddress = ReciverEmailAddress + result.Email + ';';
                                        if (State == 1 || State == 3) {
                                            if (h == row.length) {
                                                if (err == false) {
                                                    EmailSend();
                                                }
                                            }
                                        }
                                        else if (State == 4) {
                                            if (h == row.length) {
                                                if (err == false) {
                                                    SendECE();
                                                }
                                            }
                                        }
                                    }
                                }
                            });

                        }
                    }
                });


            });
            function EmailSend() {
                $('#lblEmailAdressError').html('');
                isWinOpen = false;

                $("#MailContact").remove();

                $.ajax({
                    type: "GET",
                    url: '/home/SendEmail?LetterID=' + LetterID + '&Reciver=' + ReciverEmailAddress,
                    success: function (data) {
                        windowAppend('body', '/metro/error');
                        $('#message').html(data);
                        $("#error .wintitle").html("پیغام");


                        if (State == 2) {
                            $("#error").remove();

                            if (Assignmentdata != '') {
                                PostForm(Assignmentdata, '@Url.Content("~/Assignment/Save")', "#win");
                            }
                        }
                    },
                    failure: function (data) {
                        alert(data.data);
                    }
                });
            }
            function SendECE() {
                $('#lblEmailAdressError').html('');
                isWinOpen = false;

                $("#MailContact").remove();
               // window.location.href = '@Url.Content("~/home/SendECEByEmail/")' + '?LetterID=' + LetterID + '&Reciver=' + ReciverEmailAddress;
                                $.ajax({
                                    type: "GET",
                                    url: '/home/SendECEByEmail?LetterID=' + LetterID + '&Reciver=' + ReciverEmailAddress + "&ReceiveType=" + "@ViewBag.RoneveshtType",
                                    success: function (data) {
                                        windowAppend('body', '/metro/error');
                                        $('#message').html(data);
                                        $("#error .wintitle").html("پیغام");
                                        
                                    },
                                    failure: function (data) {
                                        alert(data.data);
                                    }
                                });
            }
            function ReloadMail(Url, gridname, ReciverName, EmailAddress) {
                var grid = $('#' + gridname).data('kendoGrid');
                $.ajax({
                    url: Url,
                    type: 'get',
                    datatype: 'json',
                    data: { ReciverName: ReciverName, EmailAddress: EmailAddress },
                    error: function (xhr, status, error) {
                        alert(xhr + status);
                    },
                    success: function (result) {
                        $("#" + gridname).data("kendoGrid").dataSource.data(result);
                    }
                });
            }

            function PostFormMail(datas, url, id) {
                var sendInfo = datas;
                $('#Lock').show();
                $.ajax({
                    type: "POST",
                    url: url,
                    datatype: "json",
                    data: JSON.stringify(sendInfo),
                    contentType: 'application/json',
                    success: function (data) {
                        var m = data;
                        windowAppend("body", "/metro/error");
                        $("#message").html(m.data);
                        switch (m.state) {
                            case 0:
                                $("#error .wintitle").html("ذخیره موفق");
                                break;
                            case 1:
                                $("#error .wintitle").html("خطا");
                                break;
                        }
                        
                        $('#Lock').hide();

                    },
                    failure: function (data) {
                        alert(data.data);
                    }
                });
            }

        </script>
     @Automation.Helper.winClass.windowFother();
</div>
